(function(){"use strict";function O(){return c.close_database()}function U(r,e,t){return c.ensure_ingested(r,e,t)}function E(r,e){const t=c.get_available_time_controls(r,e);if(t[2])throw u(t[1]);return u(t[0])}function L(r,e,t,n,_,o){const s=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),i=b;var d=l(_)?0:w(_,c.__wbindgen_malloc,c.__wbindgen_realloc),R=b;const T=c.get_continuations(r,e,t,s,i,d,R,o);if(T[2])throw u(T[1]);return u(T[0])}function W(r){const e=c.get_games_metadata(r);if(e[2])throw u(e[1]);return u(e[0])}function j(r){const e=c.get_games_moves(r);if(e[2])throw u(e[1]);return u(e[0])}function C(){const r=c.get_player_info();if(r[2])throw u(r[1]);return u(r[0])}function q(r,e,t,n){const _=c.get_recent_games(r,e,t,n);if(_[2])throw u(_[1]);return u(_[0])}function B(){return c.get_schema_version()>>>0}function P(r,e){const t=w(r,c.__wbindgen_malloc,c.__wbindgen_realloc),n=b,_=w(e,c.__wbindgen_malloc,c.__wbindgen_realloc),o=b;return c.init_vfs(t,n,_,o)}function $(){return c.open_database()}function H(r,e,t,n,_){const o=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),s=b;var i=l(_)?0:w(_,c.__wbindgen_malloc,c.__wbindgen_realloc),d=b;const R=c.search_by_position(r,e,t,o,s,i,d);if(R[2])throw u(R[1]);return u(R[0])}function z(){return{__proto__:null,"./chess_db_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){return Error(f(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const n=String(t),_=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),o=b;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const t=e,n=typeof t=="boolean"?t:void 0;return l(n)?16777215:n?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,t){const n=I(t),_=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),o=b;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg___wbindgen_is_function_0095a73b8b156f76:function(e){return typeof e=="function"},__wbg___wbindgen_is_object_5ae8e5880f2c1fbd:function(e){const t=e;return typeof t=="object"&&t!==null},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,t){return e==t},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,t){const n=t,_=typeof n=="number"?n:void 0;g().setFloat64(e+8,l(_)?0:_,!0),g().setInt32(e+0,!l(_),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,t){const n=t,_=typeof n=="string"?n:void 0;var o=l(_)?0:w(_,c.__wbindgen_malloc,c.__wbindgen_realloc),s=b;g().setInt32(e+4,s,!0),g().setInt32(e+0,o,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(f(e,t))},__wbg__wbg_cb_unref_d9b87ff7982e3b21:function(e){e._wbg_cb_unref()},__wbg_body_3a0b4437dadea6bf:function(e){const t=e.body;return l(t)?0:m(t)},__wbg_buffer_26d0910f3a5bc899:function(e){return e.buffer},__wbg_byteLength_3417f266f4bf562a:function(e){return e.byteLength},__wbg_byteOffset_f88547ca47c86358:function(e){return e.byteOffset},__wbg_call_389efe28435a9388:function(){return a(function(e,t){return e.call(t)},arguments)},__wbg_call_4708e0c13bdc8e95:function(){return a(function(e,t,n){return e.call(t,n)},arguments)},__wbg_createSyncAccessHandle_6457c2b3542fa571:function(e){return e.createSyncAccessHandle()},__wbg_done_57b39ecd9addfe81:function(e){return e.done},__wbg_entries_04a4b982351a717f:function(e){return e.entries()},__wbg_entries_58c7934c745daac7:function(e){return Object.entries(e)},__wbg_fetch_a9bc66c159c18e19:function(e){return fetch(e)},__wbg_fill_5a59b1df3387126e:function(e,t,n,_){return e.fill(t,n>>>0,_>>>0)},__wbg_flush_22b785060592ca5f:function(){return a(function(e){e.flush()},arguments)},__wbg_getDate_db46eca87d2b4907:function(e){return e.getDate()},__wbg_getDay_ac81e9e1156dfde2:function(e){return e.getDay()},__wbg_getDirectoryHandle_87ce8ca53cf4d8dc:function(e,t,n,_){return e.getDirectoryHandle(f(t,n),_)},__wbg_getDirectory_b66ae3e79f902982:function(e){return e.getDirectory()},__wbg_getFileHandle_ff4ab917b45affb3:function(e,t,n,_){return e.getFileHandle(f(t,n),_)},__wbg_getFullYear_30ddf266b7612036:function(e){return e.getFullYear()},__wbg_getHours_e02e88722301c418:function(e){return e.getHours()},__wbg_getMinutes_eb73ceeb8231f6f4:function(e){return e.getMinutes()},__wbg_getMonth_4af888e76b42bb51:function(e){return e.getMonth()},__wbg_getRandomValues_933a06e2370405af:function(){return a(function(e,t){globalThis.crypto.getRandomValues(p(e,t))},arguments)},__wbg_getReader_804829cfb24eb4dd:function(e){return e.getReader()},__wbg_getSeconds_d5269a98a03bab5e:function(e){return e.getSeconds()},__wbg_getSize_0a848f6914efc400:function(){return a(function(e){return e.getSize()},arguments)},__wbg_getTime_1e3cd1391c5c3995:function(e){return e.getTime()},__wbg_getTimezoneOffset_81776d10a4ec18a8:function(e){return e.getTimezoneOffset()},__wbg_getUint32_cb62f3b295fd220d:function(e,t){return e.getUint32(t>>>0)},__wbg_get_9b94d73e6221f75c:function(e,t){return e[t>>>0]},__wbg_get_b3ed3ad4be2bc8ac:function(){return a(function(e,t){return Reflect.get(e,t)},arguments)},__wbg_get_index_9a5bfdd2ca49c65f:function(e,t){return e[t>>>0]},__wbg_headers_5a897f7fee9a0571:function(e){return e.headers},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},__wbg_instanceof_Error_8573fe0b0b480f46:function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},__wbg_instanceof_Promise_0094681e3519d6ec:function(e){let t;try{t=e instanceof Promise}catch{t=!1}return t},__wbg_instanceof_ReadableStreamDefaultReader_8c3866331ce32722:function(e){let t;try{t=e instanceof ReadableStreamDefaultReader}catch{t=!1}return t},__wbg_instanceof_Response_ee1d54d79ae41977:function(e){let t;try{t=e instanceof Response}catch{t=!1}return t},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},__wbg_instanceof_WorkerGlobalScope_07b9d5514ff0156e:function(e){let t;try{t=e instanceof WorkerGlobalScope}catch{t=!1}return t},__wbg_isArray_d314bb98fcf08331:function(e){return Array.isArray(e)},__wbg_iterator_6ff6560ca1568e55:function(){return Symbol.iterator},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_length_35a7bace40f36eac:function(e){return e.length},__wbg_message_9ddc4b9a62a7c379:function(e){return e.message},__wbg_name_446e25ef2cfdab5a:function(e){return e.name},__wbg_navigator_4478931f32ebca57:function(e){return e.navigator},__wbg_new_074b505417ada2d9:function(){return a(function(){return new URLSearchParams},arguments)},__wbg_new_0_73afc35eb544e539:function(){return new Date},__wbg_new_245cd5c49157e602:function(e){return new Date(e)},__wbg_new_2ac7fa8be584d280:function(e,t,n){return new DataView(e,t>>>0,n>>>0)},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_64284bd487f9d239:function(){return a(function(){return new Headers},arguments)},__wbg_new_b5d9e2fb389fef91:function(e,t){try{var n={a:e,b:t},_=(s,i)=>{const d=n.a;n.a=0;try{return V(d,n.b,s,i)}finally{n.a=d}};return new Promise(_)}finally{n.a=n.b=0}},__wbg_new_c2f21774701ddac7:function(){return a(function(e,t){return new URL(f(e,t))},arguments)},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,t){return new Function(f(e,t))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_new_with_str_a7c7f835549b152a:function(){return a(function(e,t){return new Request(f(e,t))},arguments)},__wbg_new_with_str_and_init_a61cbc6bdef21614:function(){return a(function(e,t,n){return new Request(f(e,t),n)},arguments)},__wbg_new_with_year_month_day_bae39ca1cb72136b:function(e,t,n){return new Date(e>>>0,t,n)},__wbg_next_0a5e0f8af98146aa:function(){return a(function(e){return e.next()},arguments)},__wbg_next_3482f54c49e8af19:function(){return a(function(e){return e.next()},arguments)},__wbg_next_418f80d8f5303233:function(e){return e.next},__wbg_now_a3af9a2f4bbaa4d1:function(){return Date.now()},__wbg_ok_87f537440a0acf85:function(e){return e.ok},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,t,n){Uint8Array.prototype.set.call(p(e,t),n)},__wbg_queueMicrotask_0aa0a927f78f5d98:function(e){return e.queueMicrotask},__wbg_queueMicrotask_5bb536982f78a56f:function(e){queueMicrotask(e)},__wbg_random_912284dbf636f269:function(){return Math.random()},__wbg_read_2bd3e0082033991e:function(){return a(function(e,t,n){return e.read(t,n)},arguments)},__wbg_read_68fd377df67e19b0:function(e){return e.read()},__wbg_read_f161889777645afd:function(){return a(function(e,t,n,_){return e.read(p(t,n),_)},arguments)},__wbg_resolve_002c4b7d9d8f6b64:function(e){return Promise.resolve(e)},__wbg_search_143f09a35047e800:function(e,t){const n=t.search,_=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),o=b;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg_setUint32_a531b0e13441116c:function(e,t,n){e.setUint32(t>>>0,n>>>0)},__wbg_set_3f1d0b984ed272ed:function(e,t,n){e[t]=n},__wbg_set_at_e453cf3f4be9e2d9:function(e,t){e.at=t},__wbg_set_cc56eefd2dd91957:function(e,t,n){e.set(p(t,n))},__wbg_set_create_1f902c5936adde7d:function(e,t){e.create=t!==0},__wbg_set_create_c95ddca018fac9ce:function(e,t){e.create=t!==0},__wbg_set_db769d02949a271d:function(){return a(function(e,t,n,_,o){e.set(f(t,n),f(_,o))},arguments)},__wbg_set_f43e577aea94465b:function(e,t,n){e[t>>>0]=n},__wbg_set_headers_cfc5f4b2c1f20549:function(e,t){e.headers=t},__wbg_set_method_c3e20375f5ae7fac:function(e,t,n){e.method=f(t,n)},__wbg_set_search_1d369b0f3868e132:function(e,t,n){e.search=f(t,n)},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return l(e)?0:m(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return l(e)?0:m(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return l(e)?0:m(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return l(e)?0:m(e)},__wbg_status_89d7e803db911ee7:function(e){return e.status},__wbg_storage_c002b53bc4883299:function(e){return e.storage},__wbg_subarray_a96e1fef17ed23cb:function(e,t,n){return e.subarray(t>>>0,n>>>0)},__wbg_text_083b8727c990c8c0:function(){return a(function(e){return e.text()},arguments)},__wbg_then_0d9fe2c7b1857d32:function(e,t,n){return e.then(t,n)},__wbg_then_b9e7b3b5f1a9e1b5:function(e,t){return e.then(t)},__wbg_toString_029ac24421fd7a24:function(e){return e.toString()},__wbg_toString_964ff7fe6eca8362:function(e){return e.toString()},__wbg_truncate_ce7c4fbc0eec97a1:function(){return a(function(e,t){e.truncate(t)},arguments)},__wbg_truncate_dc661fdcb0062fa7:function(){return a(function(e,t){e.truncate(t>>>0)},arguments)},__wbg_url_36c39f6580d05409:function(e,t){const n=t.url,_=w(n,c.__wbindgen_malloc,c.__wbindgen_realloc),o=b;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg_value_0546255b415e96c1:function(e){return e.value},__wbg_write_2d59337cc496919d:function(){return a(function(e,t,n,_){return e.write(p(t,n),_)},arguments)},__wbg_write_2f06684823b49afb:function(){return a(function(e,t,n){return e.write(t,n)},arguments)},__wbindgen_cast_0000000000000001:function(e,t){return N(e,t,c.wasm_bindgen__closure__destroy__hcdd03d0ab3a5230c,G)},__wbindgen_cast_0000000000000002:function(e){return e},__wbindgen_cast_0000000000000003:function(e){return e},__wbindgen_cast_0000000000000004:function(e,t){return f(e,t)},__wbindgen_init_externref_table:function(){const e=c.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)}}}}function G(r,e,t){c.wasm_bindgen__convert__closures_____invoke__h5d5c897e17218bb0(r,e,t)}function V(r,e,t,n){c.wasm_bindgen__convert__closures_____invoke__h48e0ae2f1b2979a4(r,e,t,n)}function m(r){const e=c.__externref_table_alloc();return c.__wbindgen_externrefs.set(e,r),e}const F=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(r=>r.dtor(r.a,r.b));function I(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const _=r.description;return _==null?"Symbol":`Symbol(${_})`}if(e=="function"){const _=r.name;return typeof _=="string"&&_.length>0?`Function(${_})`:"Function"}if(Array.isArray(r)){const _=r.length;let o="[";_>0&&(o+=I(r[0]));for(let s=1;s<_;s++)o+=", "+I(r[s]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t&&t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function p(r,e){return r=r>>>0,S().subarray(r/1,r/1+e)}let y=null;function g(){return(y===null||y.buffer.detached===!0||y.buffer.detached===void 0&&y.buffer!==c.memory.buffer)&&(y=new DataView(c.memory.buffer)),y}function f(r,e){return r=r>>>0,J(r,e)}let h=null;function S(){return(h===null||h.byteLength===0)&&(h=new Uint8Array(c.memory.buffer)),h}function a(r,e){try{return r.apply(this,e)}catch(t){const n=m(t);c.__wbindgen_exn_store(n)}}function l(r){return r==null}function N(r,e,t,n){const _={a:r,b:e,cnt:1,dtor:t},o=(...s)=>{_.cnt++;const i=_.a;_.a=0;try{return n(i,_.b,...s)}finally{_.a=i,o._wbg_cb_unref()}};return o._wbg_cb_unref=()=>{--_.cnt===0&&(_.dtor(_.a,_.b),_.a=0,F.unregister(_))},F.register(o,_,_),o}function w(r,e,t){if(t===void 0){const i=M.encode(r),d=e(i.length,1)>>>0;return S().subarray(d,d+i.length).set(i),b=i.length,d}let n=r.length,_=e(n,1)>>>0;const o=S();let s=0;for(;s<n;s++){const i=r.charCodeAt(s);if(i>127)break;o[_+s]=i}if(s!==n){s!==0&&(r=r.slice(s)),_=t(_,n,n=s+r.length*3,1)>>>0;const i=S().subarray(_+s,_+n),d=M.encodeInto(r,i);s+=d.written,_=t(_,n,s,1)>>>0}return b=s,_}function u(r){const e=c.__wbindgen_externrefs.get(r);return c.__externref_table_dealloc(r),e}let x=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});x.decode();const Y=2146435072;let v=0;function J(r,e){return v+=e,v>=Y&&(x=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),x.decode(),v=e),x.decode(S().subarray(r,r+e))}const M=new TextEncoder;"encodeInto"in M||(M.encodeInto=function(r,e){const t=M.encode(r);return e.set(t),{read:r.length,written:t.length}});let b=0,c;function K(r,e){return c=r.exports,y=null,h=null,c.__wbindgen_start(),c}async function X(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(_){if(r.ok&&t(r.type)&&r.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",_);else throw _}const n=await r.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(r,e);return n instanceof WebAssembly.Instance?{instance:n,module:r}:n}function t(n){switch(n){case"basic":case"cors":case"default":return!0}return!1}}async function Q(r){if(c!==void 0)return c;r!==void 0&&(Object.getPrototypeOf(r)===Object.prototype?{module_or_path:r}=r:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),r===void 0&&(r=new URL(""+new URL("chess_db_bg-KFt8xxw7.wasm",self.location.href).href,self.location.href));const e=z();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await X(await r,e);return K(t)}let A=null;const k=new Set,D=new Map;async function Z(r,e){await Q(),await P(r,e),await $(),console.log(`[db-worker] Ready: ${e}/${r}, schema v${B()}`)}self.onmessage=async r=>{const e=r.data;if(e.type==="init"){A=Z(e.username,e.platform);return}if(e.type==="cancel"){k.add(e.cancelRequestId);return}if(e.type==="shutdown"){A&&await A,await O(),self.close();return}A&&await A;const{requestId:t}=e;try{switch(e.type){case"ensureIngested":{const n=_=>(self.postMessage({type:"progress",requestId:t,message:_}),!k.has(t));await U(e.since,e.until,n),k.delete(t),self.postMessage({type:"result",requestId:t,data:null});break}case"getContinuations":{const n=L(e.since,e.until,e.moveSequence,e.playerColor,e.timeControl??void 0,e.includeTranspositions);self.postMessage({type:"result",requestId:t,data:n});break}case"searchByPosition":{const n=e.tabId,_=(D.get(n)??0)+1;if(D.set(n,_),await new Promise(s=>{const i=new MessageChannel;i.port1.onmessage=()=>s(),i.port2.postMessage(null)}),_!==D.get(n)){self.postMessage({type:"conflated",requestId:t});break}const o=H(e.since,e.until,e.pattern.pieces,e.playerColor,e.timeControl??void 0);self.postMessage({type:"result",requestId:t,data:o});break}case"getGamesMetadata":{const n=W(e.gameIds);self.postMessage({type:"result",requestId:t,data:n});break}case"getGamesMoves":{const n=j(e.gameIds);self.postMessage({type:"result",requestId:t,data:n});break}case"getRecentGames":{const n=q(e.since,e.until,e.timeControl??null,e.limit);self.postMessage({type:"result",requestId:t,data:n});break}case"getAvailableTimeControls":{const n=E(e.since,e.until);self.postMessage({type:"result",requestId:t,data:n});break}case"getPlayerInfo":{const n=C();self.postMessage({type:"result",requestId:t,data:n});break}default:self.postMessage({type:"error",requestId:t,error:`Unknown message type: ${e.type}`})}}catch(n){k.delete(t);const _=String(n);_.includes("Cancelled")?self.postMessage({type:"error",requestId:t,error:"AbortError"}):self.postMessage({type:"error",requestId:t,error:_})}}})();
