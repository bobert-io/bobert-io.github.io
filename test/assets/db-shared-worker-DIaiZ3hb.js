(function(){"use strict";function V(){return u.get_schema_version()>>>0}function te(){return{__proto__:null,"./chess_db_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){return Error(w(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const n=String(t),o=v(n,u.__wbindgen_malloc,u.__wbindgen_realloc),a=R;p().setInt32(e+4,a,!0),p().setInt32(e+0,o,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const t=e,n=typeof t=="boolean"?t:void 0;return h(n)?16777215:n?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,t){const n=B(t),o=v(n,u.__wbindgen_malloc,u.__wbindgen_realloc),a=R;p().setInt32(e+4,a,!0),p().setInt32(e+0,o,!0)},__wbg___wbindgen_is_function_0095a73b8b156f76:function(e){return typeof e=="function"},__wbg___wbindgen_is_object_5ae8e5880f2c1fbd:function(e){const t=e;return typeof t=="object"&&t!==null},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,t){return e==t},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,t){const n=t,o=typeof n=="number"?n:void 0;p().setFloat64(e+8,h(o)?0:o,!0),p().setInt32(e+0,!h(o),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,t){const n=t,o=typeof n=="string"?n:void 0;var a=h(o)?0:v(o,u.__wbindgen_malloc,u.__wbindgen_realloc),s=R;p().setInt32(e+4,s,!0),p().setInt32(e+0,a,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(w(e,t))},__wbg__wbg_cb_unref_d9b87ff7982e3b21:function(e){e._wbg_cb_unref()},__wbg_body_3a0b4437dadea6bf:function(e){const t=e.body;return h(t)?0:S(t)},__wbg_buffer_26d0910f3a5bc899:function(e){return e.buffer},__wbg_byteLength_3417f266f4bf562a:function(e){return e.byteLength},__wbg_byteOffset_f88547ca47c86358:function(e){return e.byteOffset},__wbg_call_389efe28435a9388:function(){return f(function(e,t){return e.call(t)},arguments)},__wbg_call_4708e0c13bdc8e95:function(){return f(function(e,t,n){return e.call(t,n)},arguments)},__wbg_createSyncAccessHandle_6457c2b3542fa571:function(e){return e.createSyncAccessHandle()},__wbg_done_57b39ecd9addfe81:function(e){return e.done},__wbg_entries_04a4b982351a717f:function(e){return e.entries()},__wbg_entries_58c7934c745daac7:function(e){return Object.entries(e)},__wbg_fetch_a9bc66c159c18e19:function(e){return fetch(e)},__wbg_fill_5a59b1df3387126e:function(e,t,n,o){return e.fill(t,n>>>0,o>>>0)},__wbg_flush_22b785060592ca5f:function(){return f(function(e){e.flush()},arguments)},__wbg_getDate_db46eca87d2b4907:function(e){return e.getDate()},__wbg_getDay_ac81e9e1156dfde2:function(e){return e.getDay()},__wbg_getDirectoryHandle_87ce8ca53cf4d8dc:function(e,t,n,o){return e.getDirectoryHandle(w(t,n),o)},__wbg_getDirectory_b66ae3e79f902982:function(e){return e.getDirectory()},__wbg_getFileHandle_ff4ab917b45affb3:function(e,t,n,o){return e.getFileHandle(w(t,n),o)},__wbg_getFullYear_30ddf266b7612036:function(e){return e.getFullYear()},__wbg_getHours_e02e88722301c418:function(e){return e.getHours()},__wbg_getMinutes_eb73ceeb8231f6f4:function(e){return e.getMinutes()},__wbg_getMonth_4af888e76b42bb51:function(e){return e.getMonth()},__wbg_getRandomValues_933a06e2370405af:function(){return f(function(e,t){globalThis.crypto.getRandomValues(M(e,t))},arguments)},__wbg_getReader_804829cfb24eb4dd:function(e){return e.getReader()},__wbg_getSeconds_d5269a98a03bab5e:function(e){return e.getSeconds()},__wbg_getSize_0a848f6914efc400:function(){return f(function(e){return e.getSize()},arguments)},__wbg_getTime_1e3cd1391c5c3995:function(e){return e.getTime()},__wbg_getTimezoneOffset_81776d10a4ec18a8:function(e){return e.getTimezoneOffset()},__wbg_getUint32_cb62f3b295fd220d:function(e,t){return e.getUint32(t>>>0)},__wbg_get_9b94d73e6221f75c:function(e,t){return e[t>>>0]},__wbg_get_b3ed3ad4be2bc8ac:function(){return f(function(e,t){return Reflect.get(e,t)},arguments)},__wbg_get_index_9a5bfdd2ca49c65f:function(e,t){return e[t>>>0]},__wbg_headers_5a897f7fee9a0571:function(e){return e.headers},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},__wbg_instanceof_Error_8573fe0b0b480f46:function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},__wbg_instanceof_Promise_0094681e3519d6ec:function(e){let t;try{t=e instanceof Promise}catch{t=!1}return t},__wbg_instanceof_ReadableStreamDefaultReader_8c3866331ce32722:function(e){let t;try{t=e instanceof ReadableStreamDefaultReader}catch{t=!1}return t},__wbg_instanceof_Response_ee1d54d79ae41977:function(e){let t;try{t=e instanceof Response}catch{t=!1}return t},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},__wbg_instanceof_WorkerGlobalScope_07b9d5514ff0156e:function(e){let t;try{t=e instanceof WorkerGlobalScope}catch{t=!1}return t},__wbg_isArray_d314bb98fcf08331:function(e){return Array.isArray(e)},__wbg_iterator_6ff6560ca1568e55:function(){return Symbol.iterator},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_length_35a7bace40f36eac:function(e){return e.length},__wbg_message_9ddc4b9a62a7c379:function(e){return e.message},__wbg_name_446e25ef2cfdab5a:function(e){return e.name},__wbg_navigator_4478931f32ebca57:function(e){return e.navigator},__wbg_new_074b505417ada2d9:function(){return f(function(){return new URLSearchParams},arguments)},__wbg_new_0_73afc35eb544e539:function(){return new Date},__wbg_new_245cd5c49157e602:function(e){return new Date(e)},__wbg_new_2ac7fa8be584d280:function(e,t,n){return new DataView(e,t>>>0,n>>>0)},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_64284bd487f9d239:function(){return f(function(){return new Headers},arguments)},__wbg_new_b5d9e2fb389fef91:function(e,t){try{var n={a:e,b:t},o=(s,c)=>{const g=n.a;n.a=0;try{return re(g,n.b,s,c)}finally{n.a=g}};return new Promise(o)}finally{n.a=n.b=0}},__wbg_new_c2f21774701ddac7:function(){return f(function(e,t){return new URL(w(e,t))},arguments)},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,t){return new Function(w(e,t))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_new_with_str_a7c7f835549b152a:function(){return f(function(e,t){return new Request(w(e,t))},arguments)},__wbg_new_with_str_and_init_a61cbc6bdef21614:function(){return f(function(e,t,n){return new Request(w(e,t),n)},arguments)},__wbg_new_with_year_month_day_bae39ca1cb72136b:function(e,t,n){return new Date(e>>>0,t,n)},__wbg_next_0a5e0f8af98146aa:function(){return f(function(e){return e.next()},arguments)},__wbg_next_3482f54c49e8af19:function(){return f(function(e){return e.next()},arguments)},__wbg_next_418f80d8f5303233:function(e){return e.next},__wbg_now_a3af9a2f4bbaa4d1:function(){return Date.now()},__wbg_ok_87f537440a0acf85:function(e){return e.ok},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,t,n){Uint8Array.prototype.set.call(M(e,t),n)},__wbg_queueMicrotask_0aa0a927f78f5d98:function(e){return e.queueMicrotask},__wbg_queueMicrotask_5bb536982f78a56f:function(e){queueMicrotask(e)},__wbg_random_912284dbf636f269:function(){return Math.random()},__wbg_read_2bd3e0082033991e:function(){return f(function(e,t,n){return e.read(t,n)},arguments)},__wbg_read_68fd377df67e19b0:function(e){return e.read()},__wbg_read_f161889777645afd:function(){return f(function(e,t,n,o){return e.read(M(t,n),o)},arguments)},__wbg_resolve_002c4b7d9d8f6b64:function(e){return Promise.resolve(e)},__wbg_search_143f09a35047e800:function(e,t){const n=t.search,o=v(n,u.__wbindgen_malloc,u.__wbindgen_realloc),a=R;p().setInt32(e+4,a,!0),p().setInt32(e+0,o,!0)},__wbg_setUint32_a531b0e13441116c:function(e,t,n){e.setUint32(t>>>0,n>>>0)},__wbg_set_3f1d0b984ed272ed:function(e,t,n){e[t]=n},__wbg_set_at_e453cf3f4be9e2d9:function(e,t){e.at=t},__wbg_set_cc56eefd2dd91957:function(e,t,n){e.set(M(t,n))},__wbg_set_create_1f902c5936adde7d:function(e,t){e.create=t!==0},__wbg_set_create_c95ddca018fac9ce:function(e,t){e.create=t!==0},__wbg_set_db769d02949a271d:function(){return f(function(e,t,n,o,a){e.set(w(t,n),w(o,a))},arguments)},__wbg_set_f43e577aea94465b:function(e,t,n){e[t>>>0]=n},__wbg_set_headers_cfc5f4b2c1f20549:function(e,t){e.headers=t},__wbg_set_method_c3e20375f5ae7fac:function(e,t,n){e.method=w(t,n)},__wbg_set_search_1d369b0f3868e132:function(e,t,n){e.search=w(t,n)},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return h(e)?0:S(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return h(e)?0:S(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return h(e)?0:S(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return h(e)?0:S(e)},__wbg_status_89d7e803db911ee7:function(e){return e.status},__wbg_storage_c002b53bc4883299:function(e){return e.storage},__wbg_subarray_a96e1fef17ed23cb:function(e,t,n){return e.subarray(t>>>0,n>>>0)},__wbg_text_083b8727c990c8c0:function(){return f(function(e){return e.text()},arguments)},__wbg_then_0d9fe2c7b1857d32:function(e,t,n){return e.then(t,n)},__wbg_then_b9e7b3b5f1a9e1b5:function(e,t){return e.then(t)},__wbg_toString_029ac24421fd7a24:function(e){return e.toString()},__wbg_toString_964ff7fe6eca8362:function(e){return e.toString()},__wbg_truncate_ce7c4fbc0eec97a1:function(){return f(function(e,t){e.truncate(t)},arguments)},__wbg_truncate_dc661fdcb0062fa7:function(){return f(function(e,t){e.truncate(t>>>0)},arguments)},__wbg_url_36c39f6580d05409:function(e,t){const n=t.url,o=v(n,u.__wbindgen_malloc,u.__wbindgen_realloc),a=R;p().setInt32(e+4,a,!0),p().setInt32(e+0,o,!0)},__wbg_value_0546255b415e96c1:function(e){return e.value},__wbg_write_2d59337cc496919d:function(){return f(function(e,t,n,o){return e.write(M(t,n),o)},arguments)},__wbg_write_2f06684823b49afb:function(){return f(function(e,t,n){return e.write(t,n)},arguments)},__wbindgen_cast_0000000000000001:function(e,t){return oe(e,t,u.wasm_bindgen__closure__destroy__hcdd03d0ab3a5230c,ne)},__wbindgen_cast_0000000000000002:function(e){return e},__wbindgen_cast_0000000000000003:function(e){return e},__wbindgen_cast_0000000000000004:function(e,t){return w(e,t)},__wbindgen_init_externref_table:function(){const e=u.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)}}}}function ne(r,e,t){u.wasm_bindgen__convert__closures_____invoke__h5d5c897e17218bb0(r,e,t)}function re(r,e,t,n){u.wasm_bindgen__convert__closures_____invoke__h48e0ae2f1b2979a4(r,e,t,n)}function S(r){const e=u.__externref_table_alloc();return u.__wbindgen_externrefs.set(e,r),e}const Y=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(r=>r.dtor(r.a,r.b));function B(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const o=r.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){const o=r.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(r)){const o=r.length;let a="[";o>0&&(a+=B(r[0]));for(let s=1;s<o;s++)a+=", "+B(r[s]);return a+="]",a}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t&&t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function M(r,e){return r=r>>>0,D().subarray(r/1,r/1+e)}let q=null;function p(){return(q===null||q.buffer.detached===!0||q.buffer.detached===void 0&&q.buffer!==u.memory.buffer)&&(q=new DataView(u.memory.buffer)),q}function w(r,e){return r=r>>>0,se(r,e)}let k=null;function D(){return(k===null||k.byteLength===0)&&(k=new Uint8Array(u.memory.buffer)),k}function f(r,e){try{return r.apply(this,e)}catch(t){const n=S(t);u.__wbindgen_exn_store(n)}}function h(r){return r==null}function oe(r,e,t,n){const o={a:r,b:e,cnt:1,dtor:t},a=(...s)=>{o.cnt++;const c=o.a;o.a=0;try{return n(c,o.b,...s)}finally{o.a=c,a._wbg_cb_unref()}};return a._wbg_cb_unref=()=>{--o.cnt===0&&(o.dtor(o.a,o.b),o.a=0,Y.unregister(o))},Y.register(a,o,o),a}function v(r,e,t){if(t===void 0){const c=W.encode(r),g=e(c.length,1)>>>0;return D().subarray(g,g+c.length).set(c),R=c.length,g}let n=r.length,o=e(n,1)>>>0;const a=D();let s=0;for(;s<n;s++){const c=r.charCodeAt(s);if(c>127)break;a[o+s]=c}if(s!==n){s!==0&&(r=r.slice(s)),o=t(o,n,n=s+r.length*3,1)>>>0;const c=D().subarray(o+s,o+n),g=W.encodeInto(r,c);s+=g.written,o=t(o,n,s,1)>>>0}return R=s,o}let E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});E.decode();const ae=2146435072;let H=0;function se(r,e){return H+=e,H>=ae&&(E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),E.decode(),H=e),E.decode(D().subarray(r,r+e))}const W=new TextEncoder;"encodeInto"in W||(W.encodeInto=function(r,e){const t=W.encode(r);return e.set(t),{read:r.length,written:t.length}});let R=0,u;function ce(r,e){return u=r.exports,q=null,k=null,u.__wbindgen_start(),u}async function ie(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(o){if(r.ok&&t(r.type)&&r.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await r.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(r,e);return n instanceof WebAssembly.Instance?{instance:n,module:r}:n}function t(n){switch(n){case"basic":case"cors":case"default":return!0}return!1}}async function ue(r){if(u!==void 0)return u;r!==void 0&&(Object.getPrototypeOf(r)===Object.prototype?{module_or_path:r}=r:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),r===void 0&&(r=new URL(""+new URL("chess_db_bg-Dq1KGBLq.wasm",self.location.href).href,self.location.href));const e=te();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await ie(await r,e);return ce(t)}console.log("[db-shared-worker] Starting WASM init...");const J=ue().then(()=>console.log("[db-shared-worker] WASM init done")).catch(r=>console.error("[db-shared-worker] WASM init FAILED:",r));function _e(r){const e=new TextEncoder().encode(r);let t="";for(const n of e)t+=String.fromCharCode(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}navigator.locks.request("chess-shared-worker",()=>new Promise(()=>{}));let j=0;const b=new Map,_=new Map,l=new Map,P=new Map,y=new Map,d=new Map,m=new Map,A=new Map;let L=!1;const N=[];let x=null;const I=new Map;function U(r,e){return`${e}:${r.toLowerCase()}`}function G(r){const e=[];for(const[t,n]of Object.entries(r))if(!(t==="type"||t==="port")){if(Array.isArray(n)){e.push(`${t}:[${n.length} items]`);continue}if(t==="data"&&typeof n=="object"&&n!==null){const o=Object.entries(n).map(([a,s])=>Array.isArray(s)?`${a}:${s.length}`:`${a}:${s}`).join(", ");e.push(`data:{${o}}`);continue}if(t==="pattern"&&typeof n=="object"&&n!==null){e.push(`pattern:{${n.pieces?.length??0} pieces}`);continue}if(t==="status"&&typeof n=="object"&&n!==null){e.push(`status:{kind:${n.kind}}`);continue}e.push(`${t}:${n}`)}return e.length>0?` {${e.join(", ")}}`:""}function i(r,e,t){console.log(`[shared-worker] → tab:${r} ${t.type}${G(t)}`),e.postMessage(t)}function T(r,e,t){console.log(`[shared-worker] → worker:${r} ${t.type}${G(t)}`),e.postMessage(t)}function C(r){for(const[e]of b)if(e!==r)return e;return r&&b.has(r)?r:null}function z(r){for(const e of r)if(b.has(e.tabId))return e.tabId;return null}function $(r,e){for(const t of r)i(t.tabId,t.tabPort,{type:"error",requestId:t.tabRequestId,error:e})}async function Q(r,e){for(let t=0;t<10;t++)try{await r.removeEntry(e,{recursive:!0});return}catch(n){if(t<9)await new Promise(o=>setTimeout(o,100));else throw new Error(`Failed to delete OPFS directory '${e}' after 10 attempts: ${n}`)}}function fe(r,e,t){const n={type:r.type,requestId:e};switch(r.type){case"ensureIngested":n.since=r.since,n.until=r.until;break;case"getContinuations":n.since=r.since,n.until=r.until,n.moveSequence=r.moveSequence,n.playerColor=r.playerColor,n.timeControl=r.timeControl,n.includeTranspositions=r.includeTranspositions;break;case"searchByPosition":n.since=r.since,n.until=r.until,n.tabId=t,n.pattern=r.pattern,n.playerColor=r.playerColor,n.timeControl=r.timeControl;break;case"getGamesMetadata":n.gameIds=r.gameIds;break;case"getGamesMoves":n.gameIds=r.gameIds;break;case"getRecentGames":n.since=r.since,n.until=r.until,n.timeControl=r.timeControl,n.limit=r.limit;break;case"getAvailableTimeControls":n.since=r.since,n.until=r.until;break}return n}function F(r,e,t,n,o,a){const s=b.get(n);if(!s){$(o,"No tabs available");return}console.log(`[shared-worker] ${r}: no worker → spawning (tab:${n}, attempt:${a})`),i(n,s,{type:"spawnWorker",username:e,platform:t});const c=setTimeout(()=>le(r),1e4);_.set(r,{state:"spawning",username:e,platform:t,workerPort:null,leaderTabId:n,queue:o,spawnTimeout:c,attemptCount:a})}function le(r){const e=_.get(r);if(!(!e||e.state!=="spawning")){if(console.error(`[db-shared-worker] Spawn timeout: ${r}, tab:${e.leaderTabId}, attempt:${e.attemptCount}`),e.workerPort){const t=b.get(e.leaderTabId);t&&i(e.leaderTabId,t,{type:"terminateWorker",username:e.username,platform:e.platform})}if(e.attemptCount<2){const t=C(e.leaderTabId);t?F(r,e.username,e.platform,t,e.queue,e.attemptCount+1):($(e.queue,"WorkerSpawnFailed"),_.delete(r))}else $(e.queue,"WorkerSpawnFailed"),_.delete(r)}}function de(r){const e=_.get(r);if(!(!e||e.state!=="spawning"||!e.workerPort)){clearTimeout(e.spawnTimeout),console.log(`[shared-worker] ${r}: spawning → active`),_.set(r,{state:"active",username:e.username,platform:e.platform,workerPort:e.workerPort,leaderTabId:e.leaderTabId});for(const t of e.queue)K(r,t.tabId,t.tabPort,t.msg)}}function X(r){const e=_.get(r);if(!e||e.state!=="active")return;console.log(`[shared-worker] ${r}: active → no worker (leader tab:${e.leaderTabId} died)`);const t=[];for(const[o,a]of l)a.playerKey===r&&(b.has(a.tabId)&&t.push({tabId:a.tabId,tabPort:a.tabPort,tabRequestId:a.tabRequestId,msg:a.originalMsg}),l.delete(o));const n=d.get(r)||[];for(const o of n)b.has(o.tabId)&&t.push({tabId:o.tabId,tabPort:o.tabPort,tabRequestId:o.tabRequestId,msg:{type:"ensureIngested",requestId:o.tabRequestId,username:e.username,platform:e.platform,since:o.since,until:o.until}});if(d.delete(r),P.delete(r),y.delete(r),m.delete(r),t.length>0){const o=z(t)||C();o?F(r,e.username,e.platform,o,t,1):($(t,"No tabs available"),_.delete(r))}else _.delete(r)}function Z(r){const e=_.get(r);if(!e)return;console.log(`[shared-worker] ${r}: teardown (was ${e.state})`),e.state==="spawning"&&(clearTimeout(e.spawnTimeout),$(e.queue,"Player data cleared"));const t=b.get(e.leaderTabId);t&&i(e.leaderTabId,t,{type:"terminateWorker",username:e.username,platform:e.platform});for(const[o,a]of l)a.playerKey===r&&(i(a.tabId,a.tabPort,{type:"error",requestId:a.tabRequestId,error:"Player data cleared"}),l.delete(o));const n=d.get(r)||[];for(const o of n)i(o.tabId,o.tabPort,{type:"error",requestId:o.tabRequestId,error:"Player data cleared"});d.delete(r),P.delete(r),y.delete(r),m.delete(r),_.delete(r)}function K(r,e,t,n){const o=_.get(r);if(!o||o.state!=="active")return;if(n.type==="ensureIngested"){be(r,e,t,n,o);return}const a=j++;l.set(a,{tabId:e,tabPort:t,tabRequestId:n.requestId,playerKey:r,originalMsg:n}),P.has(r)&&(i(e,t,{type:"status",requestId:n.requestId,status:{kind:"queued",ingestionProgress:P.get(r)}}),m.has(r)||m.set(r,new Set),m.get(r).add(a));const s=fe(n,a,e);T(r,o.workerPort,s)}function be(r,e,t,n,o){if(y.has(r)){d.has(r)||d.set(r,[]),d.get(r).push({tabId:e,tabPort:t,tabRequestId:n.requestId,since:n.since,until:n.until}),i(e,t,{type:"progress",requestId:n.requestId,message:"Waiting for ingestion to complete..."});return}const a=j++;l.set(a,{tabId:e,tabPort:t,tabRequestId:n.requestId,playerKey:r,originalMsg:n}),y.set(r,a),T(r,o.workerPort,{type:"ensureIngested",requestId:a,since:n.since,until:n.until})}function ge(r,e){if(console.log(`[shared-worker] ← worker:${r} ${e.type}${G(e)}`),e.type==="ready"){de(r);return}if(e.type==="playerInfoUpdated"){A.set(r,e.data);return}const{requestId:t}=e;if(e.type==="progress"){P.set(r,e.message);const n=l.get(t);n&&i(n.tabId,n.tabPort,{type:"progress",requestId:n.tabRequestId,message:e.message});const o=m.get(r);if(o)for(const a of o){const s=l.get(a);s&&i(s.tabId,s.tabPort,{type:"status",requestId:s.tabRequestId,status:{kind:"queued",ingestionProgress:e.message}})}return}if(e.type==="result"||e.type==="error"){if(y.get(r)===t){P.delete(r),y.delete(r),m.delete(r);const o=d.get(r)||[];if(d.delete(r),o.length>0){const a=o[0],s=_.get(r);if(s?.state==="active"){const c=j++,g={type:"ensureIngested",requestId:a.tabRequestId,username:s.username,platform:s.platform,since:a.since,until:a.until};l.set(c,{tabId:a.tabId,tabPort:a.tabPort,tabRequestId:a.tabRequestId,playerKey:r,originalMsg:g}),y.set(r,c),T(r,s.workerPort,{type:"ensureIngested",requestId:c,since:a.since,until:a.until})}if(o.length>1){d.set(r,o.slice(1));for(let c=1;c<o.length;c++)i(o[c].tabId,o[c].tabPort,{type:"progress",requestId:o[c].tabRequestId,message:"Waiting for ingestion to complete..."})}}}const n=l.get(t);n&&(e.type==="result"?i(n.tabId,n.tabPort,{type:"result",requestId:n.tabRequestId,data:e.data}):i(n.tabId,n.tabPort,{type:"error",requestId:n.tabRequestId,error:e.error}),l.delete(t));return}if(e.type==="conflated"){const n=l.get(t);n&&(i(n.tabId,n.tabPort,{type:"result",requestId:n.tabRequestId,data:"conflated"}),l.delete(t));return}}function we(r,e,t){if(console.log(`[shared-worker] ← tab:${r} ${t.type}${G(t)}`),t.type==="workerPort"){pe(r,t);return}if(t.type==="cachedPlayersResult"){Ie(t.data);return}if(t.type==="listCachedPlayers"){he(r,e,t.requestId);return}if(t.type==="clearPlayerData"){me(r,e,t.requestId,t.username,t.platform);return}if(t.type==="clearAllData"){qe(r,e,t.requestId);return}if(t.type==="cancel"){ye(r,e,t.cancelRequestId);return}const{username:n,platform:o}=t,a=U(n,o),s=_.get(a);if(!s){const c={tabId:r,tabPort:e,tabRequestId:t.requestId,msg:t};if(!L){I.has(a)||I.set(a,[]),I.get(a).push(c);return}F(a,n,o,r,[c],1);return}if(s.state==="spawning"){s.queue.push({tabId:r,tabPort:e,tabRequestId:t.requestId,msg:t});return}K(a,r,e,t)}function pe(r,e){const t=U(e.username,e.platform),n=_.get(t);if(!n||n.state!=="spawning")return;const o=e.port;n.workerPort=o,n.leaderTabId=r,o.onmessage=a=>{ge(t,a.data)},navigator.locks.request(`chess-worker-${e.platform}-${e.username}`,()=>{console.log(`[db-shared-worker] Worker ${t} died (Web Lock released)`),X(t)})}function ye(r,e,t){for(const[n,o]of l)if(o.tabPort===e&&o.tabRequestId===t){const a=_.get(o.playerKey);a?.state==="active"&&T(o.playerKey,a.workerPort,{type:"cancel",cancelRequestId:n});return}for(const[n,o]of d){const a=o.findIndex(s=>s.tabPort===e&&s.tabRequestId===t);if(a!==-1){o.splice(a,1),i(r,e,{type:"error",requestId:t,error:"AbortError"}),o.length===0&&d.delete(n);return}}for(const[,n]of _){if(n.state!=="spawning")continue;const o=n.queue.findIndex(a=>a.tabPort===e&&a.tabRequestId===t);if(o!==-1){n.queue.splice(o,1),i(r,e,{type:"error",requestId:t,error:"AbortError"});return}}for(const[,n]of I){const o=n.findIndex(a=>a.tabPort===e&&a.tabRequestId===t);if(o!==-1){n.splice(o,1),i(r,e,{type:"error",requestId:t,error:"AbortError"});return}}}function he(r,e,t){L?i(r,e,{type:"result",requestId:t,data:Array.from(A.values())}):N.push({tabId:r,port:e,tabRequestId:t})}function ee(r){const e=b.get(r);e&&(x=r,i(r,e,{type:"readCachedPlayers"}))}function Ie(r){for(const t of r){const n=U(t.username,t.platform);A.set(n,t)}L=!0,x=null;const e=Array.from(A.values());for(const{tabId:t,port:n,tabRequestId:o}of N)i(t,n,{type:"result",requestId:o,data:e});N.length=0;for(const[t,n]of I){if(n.length===0)continue;const o=n[0],{username:a,platform:s}=o.msg,c=z(n)||C();c?F(t,a,s,c,n,1):$(n,"No tabs available")}I.clear()}async function me(r,e,t,n,o){await J;const a=U(n,o);Z(a),A.delete(a);try{const s=await navigator.storage.getDirectory(),c=`chess_prj2-${V()}-${o}-${_e(n)}`;await Q(s,c)}catch(s){console.error("[db-shared-worker] clearPlayerData OPFS error:",s),i(r,e,{type:"error",requestId:t,error:String(s)});return}i(r,e,{type:"result",requestId:t,data:null});for(const[s,c]of b)i(s,c,{type:"reload"})}async function qe(r,e,t){await J;for(const n of[..._.keys()])Z(n);A.clear();try{const n=await navigator.storage.getDirectory(),o=`chess_prj2-${V()}-`,a=[];for await(const[s,c]of n.entries())c.kind==="directory"&&s.startsWith(o)&&a.push(s);await Promise.all(a.map(s=>Q(n,s)))}catch(n){console.error("[db-shared-worker] clearAllData OPFS error:",n),i(r,e,{type:"error",requestId:t,error:String(n)});return}i(r,e,{type:"result",requestId:t,data:null});for(const[n,o]of b)i(n,o,{type:"reload"})}function Re(r){if(b.get(r)){if(b.delete(r),x===r){x=null;const t=C();t&&ee(t)}for(const[t,n]of I){const o=n.filter(a=>a.tabId!==r);o.length===0?I.delete(t):I.set(t,o)}for(const[t,n]of _)n.state==="active"&&n.leaderTabId===r&&X(t);for(const[t,n]of _)if(n.state==="spawning"&&(n.queue=n.queue.filter(o=>o.tabId!==r),n.leaderTabId===r))if(clearTimeout(n.spawnTimeout),n.queue.length>0){const o=z(n.queue)||C();o?F(t,n.username,n.platform,o,n.queue,n.attemptCount):($(n.queue,"No tabs available"),_.delete(t))}else _.delete(t);for(const[t,n]of y){const o=l.get(n);if(o&&o.tabId===r){const a=_.get(t);a?.state==="active"&&T(t,a.workerPort,{type:"cancel",cancelRequestId:n}),y.delete(t),P.delete(t),m.delete(t);const s=(d.get(t)||[]).filter(c=>c.tabId!==r);if(d.delete(t),s.length>0&&a?.state==="active"){const c=s[0],g=j++,$e={type:"ensureIngested",requestId:c.tabRequestId,username:a.username,platform:a.platform,since:c.since,until:c.until};if(l.set(g,{tabId:c.tabId,tabPort:c.tabPort,tabRequestId:c.tabRequestId,playerKey:t,originalMsg:$e}),y.set(t,g),T(t,a.workerPort,{type:"ensureIngested",requestId:g,since:c.since,until:c.until}),s.length>1){d.set(t,s.slice(1));for(let O=1;O<s.length;O++)i(s[O].tabId,s[O].tabPort,{type:"progress",requestId:s[O].tabRequestId,message:"Waiting for ingestion to complete..."})}}}}for(const[t,n]of l)n.tabId===r&&l.delete(t);for(const[t,n]of d){const o=n.filter(a=>a.tabId!==r);o.length===0?d.delete(t):d.set(t,o)}}}const Pe=self;Pe.onconnect=r=>{const e=r.ports[0];e.onmessage=t=>{const n=t.data;if(n.type==="hello"){const o=n.tabId;console.log(`[shared-worker] ← tab:${o} hello`),b.set(o,e),e.onmessage=a=>{we(o,e,a.data)},i(o,e,{type:"helloAck"}),!L&&x===null&&ee(o),navigator.locks.request(`chess-tab-${o}`,()=>{console.log(`[db-shared-worker] Tab ${o} died (Web Lock released)`),Re(o)})}},e.start()}})();
