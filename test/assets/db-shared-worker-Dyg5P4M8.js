(function(){"use strict";function C(){return i.get_schema_version()>>>0}function B(){return{__proto__:null,"./chess_db_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){return Error(d(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const n=String(t),o=P(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=p;l().setInt32(e+4,c,!0),l().setInt32(e+0,o,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const t=e,n=typeof t=="boolean"?t:void 0;return g(n)?16777215:n?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,t){const n=v(t),o=P(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=p;l().setInt32(e+4,c,!0),l().setInt32(e+0,o,!0)},__wbg___wbindgen_is_function_0095a73b8b156f76:function(e){return typeof e=="function"},__wbg___wbindgen_is_object_5ae8e5880f2c1fbd:function(e){const t=e;return typeof t=="object"&&t!==null},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,t){return e==t},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,t){const n=t,o=typeof n=="number"?n:void 0;l().setFloat64(e+8,g(o)?0:o,!0),l().setInt32(e+0,!g(o),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,t){const n=t,o=typeof n=="string"?n:void 0;var c=g(o)?0:P(o,i.__wbindgen_malloc,i.__wbindgen_realloc),s=p;l().setInt32(e+4,s,!0),l().setInt32(e+0,c,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(d(e,t))},__wbg__wbg_cb_unref_d9b87ff7982e3b21:function(e){e._wbg_cb_unref()},__wbg_body_3a0b4437dadea6bf:function(e){const t=e.body;return g(t)?0:m(t)},__wbg_buffer_26d0910f3a5bc899:function(e){return e.buffer},__wbg_byteLength_3417f266f4bf562a:function(e){return e.byteLength},__wbg_byteOffset_f88547ca47c86358:function(e){return e.byteOffset},__wbg_call_389efe28435a9388:function(){return u(function(e,t){return e.call(t)},arguments)},__wbg_call_4708e0c13bdc8e95:function(){return u(function(e,t,n){return e.call(t,n)},arguments)},__wbg_createSyncAccessHandle_6457c2b3542fa571:function(e){return e.createSyncAccessHandle()},__wbg_done_57b39ecd9addfe81:function(e){return e.done},__wbg_entries_04a4b982351a717f:function(e){return e.entries()},__wbg_entries_58c7934c745daac7:function(e){return Object.entries(e)},__wbg_fetch_a9bc66c159c18e19:function(e){return fetch(e)},__wbg_fill_5a59b1df3387126e:function(e,t,n,o){return e.fill(t,n>>>0,o>>>0)},__wbg_flush_22b785060592ca5f:function(){return u(function(e){e.flush()},arguments)},__wbg_getDate_db46eca87d2b4907:function(e){return e.getDate()},__wbg_getDay_ac81e9e1156dfde2:function(e){return e.getDay()},__wbg_getDirectoryHandle_87ce8ca53cf4d8dc:function(e,t,n,o){return e.getDirectoryHandle(d(t,n),o)},__wbg_getDirectory_b66ae3e79f902982:function(e){return e.getDirectory()},__wbg_getFileHandle_ff4ab917b45affb3:function(e,t,n,o){return e.getFileHandle(d(t,n),o)},__wbg_getFullYear_30ddf266b7612036:function(e){return e.getFullYear()},__wbg_getHours_e02e88722301c418:function(e){return e.getHours()},__wbg_getMinutes_eb73ceeb8231f6f4:function(e){return e.getMinutes()},__wbg_getMonth_4af888e76b42bb51:function(e){return e.getMonth()},__wbg_getRandomValues_933a06e2370405af:function(){return u(function(e,t){globalThis.crypto.getRandomValues(R(e,t))},arguments)},__wbg_getReader_804829cfb24eb4dd:function(e){return e.getReader()},__wbg_getSeconds_d5269a98a03bab5e:function(e){return e.getSeconds()},__wbg_getSize_0a848f6914efc400:function(){return u(function(e){return e.getSize()},arguments)},__wbg_getTime_1e3cd1391c5c3995:function(e){return e.getTime()},__wbg_getTimezoneOffset_81776d10a4ec18a8:function(e){return e.getTimezoneOffset()},__wbg_getUint32_cb62f3b295fd220d:function(e,t){return e.getUint32(t>>>0)},__wbg_get_9b94d73e6221f75c:function(e,t){return e[t>>>0]},__wbg_get_b3ed3ad4be2bc8ac:function(){return u(function(e,t){return Reflect.get(e,t)},arguments)},__wbg_get_index_9a5bfdd2ca49c65f:function(e,t){return e[t>>>0]},__wbg_headers_5a897f7fee9a0571:function(e){return e.headers},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},__wbg_instanceof_Error_8573fe0b0b480f46:function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},__wbg_instanceof_Promise_0094681e3519d6ec:function(e){let t;try{t=e instanceof Promise}catch{t=!1}return t},__wbg_instanceof_ReadableStreamDefaultReader_8c3866331ce32722:function(e){let t;try{t=e instanceof ReadableStreamDefaultReader}catch{t=!1}return t},__wbg_instanceof_Response_ee1d54d79ae41977:function(e){let t;try{t=e instanceof Response}catch{t=!1}return t},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},__wbg_instanceof_WorkerGlobalScope_07b9d5514ff0156e:function(e){let t;try{t=e instanceof WorkerGlobalScope}catch{t=!1}return t},__wbg_isArray_d314bb98fcf08331:function(e){return Array.isArray(e)},__wbg_iterator_6ff6560ca1568e55:function(){return Symbol.iterator},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_length_35a7bace40f36eac:function(e){return e.length},__wbg_message_9ddc4b9a62a7c379:function(e){return e.message},__wbg_name_446e25ef2cfdab5a:function(e){return e.name},__wbg_navigator_4478931f32ebca57:function(e){return e.navigator},__wbg_new_074b505417ada2d9:function(){return u(function(){return new URLSearchParams},arguments)},__wbg_new_0_73afc35eb544e539:function(){return new Date},__wbg_new_245cd5c49157e602:function(e){return new Date(e)},__wbg_new_2ac7fa8be584d280:function(e,t,n){return new DataView(e,t>>>0,n>>>0)},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_64284bd487f9d239:function(){return u(function(){return new Headers},arguments)},__wbg_new_b5d9e2fb389fef91:function(e,t){try{var n={a:e,b:t},o=(s,_)=>{const a=n.a;n.a=0;try{return z(a,n.b,s,_)}finally{n.a=a}};return new Promise(o)}finally{n.a=n.b=0}},__wbg_new_c2f21774701ddac7:function(){return u(function(e,t){return new URL(d(e,t))},arguments)},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,t){return new Function(d(e,t))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_new_with_str_a7c7f835549b152a:function(){return u(function(e,t){return new Request(d(e,t))},arguments)},__wbg_new_with_str_and_init_a61cbc6bdef21614:function(){return u(function(e,t,n){return new Request(d(e,t),n)},arguments)},__wbg_new_with_year_month_day_bae39ca1cb72136b:function(e,t,n){return new Date(e>>>0,t,n)},__wbg_next_0a5e0f8af98146aa:function(){return u(function(e){return e.next()},arguments)},__wbg_next_3482f54c49e8af19:function(){return u(function(e){return e.next()},arguments)},__wbg_next_418f80d8f5303233:function(e){return e.next},__wbg_now_a3af9a2f4bbaa4d1:function(){return Date.now()},__wbg_ok_87f537440a0acf85:function(e){return e.ok},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,t,n){Uint8Array.prototype.set.call(R(e,t),n)},__wbg_queueMicrotask_0aa0a927f78f5d98:function(e){return e.queueMicrotask},__wbg_queueMicrotask_5bb536982f78a56f:function(e){queueMicrotask(e)},__wbg_random_912284dbf636f269:function(){return Math.random()},__wbg_read_2bd3e0082033991e:function(){return u(function(e,t,n){return e.read(t,n)},arguments)},__wbg_read_68fd377df67e19b0:function(e){return e.read()},__wbg_read_f161889777645afd:function(){return u(function(e,t,n,o){return e.read(R(t,n),o)},arguments)},__wbg_resolve_002c4b7d9d8f6b64:function(e){return Promise.resolve(e)},__wbg_search_143f09a35047e800:function(e,t){const n=t.search,o=P(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=p;l().setInt32(e+4,c,!0),l().setInt32(e+0,o,!0)},__wbg_setUint32_a531b0e13441116c:function(e,t,n){e.setUint32(t>>>0,n>>>0)},__wbg_set_3f1d0b984ed272ed:function(e,t,n){e[t]=n},__wbg_set_at_e453cf3f4be9e2d9:function(e,t){e.at=t},__wbg_set_cc56eefd2dd91957:function(e,t,n){e.set(R(t,n))},__wbg_set_create_1f902c5936adde7d:function(e,t){e.create=t!==0},__wbg_set_create_c95ddca018fac9ce:function(e,t){e.create=t!==0},__wbg_set_db769d02949a271d:function(){return u(function(e,t,n,o,c){e.set(d(t,n),d(o,c))},arguments)},__wbg_set_f43e577aea94465b:function(e,t,n){e[t>>>0]=n},__wbg_set_headers_cfc5f4b2c1f20549:function(e,t){e.headers=t},__wbg_set_method_c3e20375f5ae7fac:function(e,t,n){e.method=d(t,n)},__wbg_set_search_1d369b0f3868e132:function(e,t,n){e.search=d(t,n)},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return g(e)?0:m(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return g(e)?0:m(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return g(e)?0:m(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return g(e)?0:m(e)},__wbg_status_89d7e803db911ee7:function(e){return e.status},__wbg_storage_c002b53bc4883299:function(e){return e.storage},__wbg_subarray_a96e1fef17ed23cb:function(e,t,n){return e.subarray(t>>>0,n>>>0)},__wbg_text_083b8727c990c8c0:function(){return u(function(e){return e.text()},arguments)},__wbg_then_0d9fe2c7b1857d32:function(e,t,n){return e.then(t,n)},__wbg_then_b9e7b3b5f1a9e1b5:function(e,t){return e.then(t)},__wbg_toString_029ac24421fd7a24:function(e){return e.toString()},__wbg_toString_964ff7fe6eca8362:function(e){return e.toString()},__wbg_truncate_ce7c4fbc0eec97a1:function(){return u(function(e,t){e.truncate(t)},arguments)},__wbg_truncate_dc661fdcb0062fa7:function(){return u(function(e,t){e.truncate(t>>>0)},arguments)},__wbg_url_36c39f6580d05409:function(e,t){const n=t.url,o=P(n,i.__wbindgen_malloc,i.__wbindgen_realloc),c=p;l().setInt32(e+4,c,!0),l().setInt32(e+0,o,!0)},__wbg_value_0546255b415e96c1:function(e){return e.value},__wbg_write_2d59337cc496919d:function(){return u(function(e,t,n,o){return e.write(R(t,n),o)},arguments)},__wbg_write_2f06684823b49afb:function(){return u(function(e,t,n){return e.write(t,n)},arguments)},__wbindgen_cast_0000000000000001:function(e,t){return V(e,t,i.wasm_bindgen__closure__destroy__hcdd03d0ab3a5230c,H)},__wbindgen_cast_0000000000000002:function(e){return e},__wbindgen_cast_0000000000000003:function(e){return e},__wbindgen_cast_0000000000000004:function(e,t){return d(e,t)},__wbindgen_init_externref_table:function(){const e=i.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)}}}}function H(r,e,t){i.wasm_bindgen__convert__closures_____invoke__h5d5c897e17218bb0(r,e,t)}function z(r,e,t,n){i.wasm_bindgen__convert__closures_____invoke__h48e0ae2f1b2979a4(r,e,t,n)}function m(r){const e=i.__externref_table_alloc();return i.__wbindgen_externrefs.set(e,r),e}const L=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(r=>r.dtor(r.a,r.b));function v(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const o=r.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){const o=r.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(r)){const o=r.length;let c="[";o>0&&(c+=v(r[0]));for(let s=1;s<o;s++)c+=", "+v(r[s]);return c+="]",c}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t&&t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function R(r,e){return r=r>>>0,A().subarray(r/1,r/1+e)}let y=null;function l(){return(y===null||y.buffer.detached===!0||y.buffer.detached===void 0&&y.buffer!==i.memory.buffer)&&(y=new DataView(i.memory.buffer)),y}function d(r,e){return r=r>>>0,Y(r,e)}let S=null;function A(){return(S===null||S.byteLength===0)&&(S=new Uint8Array(i.memory.buffer)),S}function u(r,e){try{return r.apply(this,e)}catch(t){const n=m(t);i.__wbindgen_exn_store(n)}}function g(r){return r==null}function V(r,e,t,n){const o={a:r,b:e,cnt:1,dtor:t},c=(...s)=>{o.cnt++;const _=o.a;o.a=0;try{return n(_,o.b,...s)}finally{o.a=_,c._wbg_cb_unref()}};return c._wbg_cb_unref=()=>{--o.cnt===0&&(o.dtor(o.a,o.b),o.a=0,L.unregister(o))},L.register(c,o,o),c}function P(r,e,t){if(t===void 0){const _=D.encode(r),a=e(_.length,1)>>>0;return A().subarray(a,a+_.length).set(_),p=_.length,a}let n=r.length,o=e(n,1)>>>0;const c=A();let s=0;for(;s<n;s++){const _=r.charCodeAt(s);if(_>127)break;c[o+s]=_}if(s!==n){s!==0&&(r=r.slice(s)),o=t(o,n,n=s+r.length*3,1)>>>0;const _=A().subarray(o+s,o+n),a=D.encodeInto(r,_);s+=a.written,o=t(o,n,s,1)>>>0}return p=s,o}let T=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});T.decode();const N=2146435072;let F=0;function Y(r,e){return F+=e,F>=N&&(T=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),T.decode(),F=e),T.decode(A().subarray(r,r+e))}const D=new TextEncoder;"encodeInto"in D||(D.encodeInto=function(r,e){const t=D.encode(r);return e.set(t),{read:r.length,written:t.length}});let p=0,i;function J(r,e){return i=r.exports,y=null,S=null,i.__wbindgen_start(),i}async function X(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(o){if(r.ok&&t(r.type)&&r.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await r.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(r,e);return n instanceof WebAssembly.Instance?{instance:n,module:r}:n}function t(n){switch(n){case"basic":case"cors":case"default":return!0}return!1}}async function Q(r){if(i!==void 0)return i;r!==void 0&&(Object.getPrototypeOf(r)===Object.prototype?{module_or_path:r}=r:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),r===void 0&&(r=new URL("/test/assets/chess_db_bg-KFt8xxw7.wasm",self.location.href));const e=B();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await X(await r,e);return J(t)}console.log("[db-shared-worker] Starting WASM init...");const O=Q().then(()=>console.log("[db-shared-worker] WASM init done")).catch(r=>console.error("[db-shared-worker] WASM init FAILED:",r));function Z(r){const e=new TextEncoder().encode(r);let t="";for(const n of e)t+=String.fromCharCode(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function K(r){const e=r.replace(/-/g,"+").replace(/_/g,"/"),t=e+"=".repeat((4-e.length%4)%4),n=atob(t),o=Uint8Array.from(n,c=>c.charCodeAt(0));return new TextDecoder().decode(o)}let ee=0,W=0;const x=new Map,w=new Map,f=new Map,k=new Map,q=new Map,h=new Map,b=new Map,I=new Map;function E(r,e){return`${e}:${r.toLowerCase()}`}async function j(r,e){for(let t=0;t<10;t++)try{await r.removeEntry(e,{recursive:!0});return}catch{t<9&&await new Promise(n=>setTimeout(n,50))}}function U(r,e){const t=E(r,e);let n=w.get(t);return n||(console.log(`[db-shared-worker] Spawning worker for ${e}/${r}`),n=new Worker(new URL("/test/assets/db-worker-lpRevS7w.js",self.location.href),{type:"module"}),n.postMessage({type:"init",username:r,platform:e}),n.onmessage=o=>{ne(t,o.data)},n.onerror=()=>{for(const[o,c]of f)c.playerKey===t&&(c.tabPort.postMessage({type:"error",requestId:c.tabRequestId,error:"Worker crashed"}),f.delete(o));for(const[o,c]of k)c(null),k.delete(o);w.delete(t),q.delete(t),h.delete(t),b.delete(t),I.delete(t)},w.set(t,n),n)}function te(r,e){return new Promise(t=>{const n=W++;k.set(n,t),r.postMessage({...e,requestId:n})})}async function $(r){const e=w.get(r);if(!e)return;e.terminate(),w.delete(r);for(const[n,o]of f)o.playerKey===r&&(o.tabPort.postMessage({type:"error",requestId:o.tabRequestId,error:"Worker shut down"}),f.delete(n));q.delete(r),h.delete(r);const t=b.get(r)||[];for(const n of t)n.tabPort.postMessage({type:"error",requestId:n.tabRequestId,error:"Worker shut down"});b.delete(r),I.delete(r)}function ne(r,e){const{requestId:t}=e,n=k.get(t);if(n){k.delete(t),n(e.type==="result"?e.data:null);return}if(e.type==="progress"){q.set(r,e.message);const o=f.get(t);o&&o.tabPort.postMessage({type:"progress",requestId:o.tabRequestId,message:e.message});const c=I.get(r);if(c)for(const s of c){const _=f.get(s);_&&_.tabPort.postMessage({type:"status",requestId:_.tabRequestId,status:{kind:"queued",ingestionProgress:e.message}})}return}if(e.type==="result"||e.type==="error"){if(h.get(r)===t){q.delete(r),h.delete(r),I.delete(r);const c=b.get(r)||[];if(b.delete(r),c.length>0){const s=c[0],_=W++;f.set(_,{tabPort:s.tabPort,tabRequestId:s.tabRequestId,playerKey:r}),h.set(r,_);const a=w.get(r);if(a&&a.postMessage({type:"ensureIngested",requestId:_,since:s.since,until:s.until}),c.length>1){b.set(r,c.slice(1));for(let M=1;M<c.length;M++)c[M].tabPort.postMessage({type:"progress",requestId:c[M].tabRequestId,message:"Waiting for ingestion to complete..."})}}}const o=f.get(t);o&&(e.type==="result"?o.tabPort.postMessage({type:"result",requestId:o.tabRequestId,data:e.data}):o.tabPort.postMessage({type:"error",requestId:o.tabRequestId,error:e.error}),f.delete(t));return}if(e.type==="conflated"){const o=f.get(t);o&&(o.tabPort.postMessage({type:"result",requestId:o.tabRequestId,data:"conflated"}),f.delete(t));return}}function re(r,e,t){if(t.type==="ping"){e.postMessage({type:"pong"});return}if(t.type==="listCachedPlayers"){se(e,t.requestId);return}if(t.type==="clearPlayerData"){ae(e,t.requestId,t.username,t.platform);return}if(t.type==="clearAllData"){_e(e,t.requestId);return}if(t.type==="cancel"){ce(e,t.cancelRequestId);return}const{username:n,platform:o}=t,c=E(n,o);if(t.type==="ensureIngested"){oe(e,t,c,n,o);return}const s=U(n,o),_=W++;f.set(_,{tabPort:e,tabRequestId:t.requestId,playerKey:c}),q.has(c)&&(e.postMessage({type:"status",requestId:t.requestId,status:{kind:"queued",ingestionProgress:q.get(c)}}),I.has(c)||I.set(c,new Set),I.get(c).add(_));const a={type:t.type,requestId:_};switch(t.type){case"getContinuations":a.since=t.since,a.until=t.until,a.moveSequence=t.moveSequence,a.playerColor=t.playerColor,a.timeControl=t.timeControl,a.includeTranspositions=t.includeTranspositions;break;case"searchByPosition":a.since=t.since,a.until=t.until,a.tabId=r,a.pattern=t.pattern,a.playerColor=t.playerColor,a.timeControl=t.timeControl;break;case"getGamesMetadata":a.gameIds=t.gameIds;break;case"getGamesMoves":a.gameIds=t.gameIds;break;case"getRecentGames":a.since=t.since,a.until=t.until,a.timeControl=t.timeControl,a.limit=t.limit;break;case"getAvailableTimeControls":a.since=t.since,a.until=t.until;break}s.postMessage(a)}function oe(r,e,t,n,o){if(h.has(t)){b.has(t)||b.set(t,[]),b.get(t).push({tabPort:r,tabRequestId:e.requestId,since:e.since,until:e.until}),r.postMessage({type:"progress",requestId:e.requestId,message:"Waiting for ingestion to complete..."});return}const c=U(n,o),s=W++;f.set(s,{tabPort:r,tabRequestId:e.requestId,playerKey:t}),h.set(t,s),c.postMessage({type:"ensureIngested",requestId:s,since:e.since,until:e.until})}function ce(r,e){for(const[t,n]of f)if(n.tabPort===r&&n.tabRequestId===e){const o=w.get(n.playerKey);o&&o.postMessage({type:"cancel",cancelRequestId:t});return}for(const[t,n]of b){const o=n.findIndex(c=>c.tabPort===r&&c.tabRequestId===e);if(o!==-1){n.splice(o,1),r.postMessage({type:"error",requestId:e,error:"AbortError"}),n.length===0&&b.delete(t);return}}}async function se(r,e){try{await O;const t=await navigator.storage.getDirectory(),n=`chess_prj2-${C()}-`,o=[];for await(const[c,s]of t.entries()){if(s.kind!=="directory"||!c.startsWith(n))continue;const _=c.slice(n.length),a=_.indexOf("-");if(a===-1)continue;const M=_.slice(0,a),fe=_.slice(a+1);try{const be=K(fe),de=U(be,M),G=await te(de,{type:"getPlayerInfo"});G&&o.push(G)}catch{continue}}r.postMessage({type:"result",requestId:e,data:o})}catch(t){r.postMessage({type:"error",requestId:e,error:String(t)})}}async function ae(r,e,t,n){await O;const o=E(t,n);await $(o);const c=await navigator.storage.getDirectory(),s=`chess_prj2-${C()}-${n}-${Z(t)}`;await j(c,s),r.postMessage({type:"result",requestId:e,data:null});for(const[,_]of x)_.postMessage({type:"reload"})}async function _e(r,e){await O,await Promise.all([...w.keys()].map(t=>$(t)));try{const t=await navigator.storage.getDirectory(),n=`chess_prj2-${C()}-`,o=[];for await(const[c,s]of t.entries())s.kind==="directory"&&c.startsWith(n)&&o.push(c);await Promise.all(o.map(c=>j(t,c)))}catch{}r.postMessage({type:"result",requestId:e,data:null});for(const[,t]of x)t.postMessage({type:"reload"})}function ie(r){for(const[e,t]of x)if(t===r){x.delete(e);break}for(const[e,t]of f)t.tabPort===r&&f.delete(e);for(const[e,t]of b){const n=t.filter(o=>o.tabPort!==r);n.length===0?b.delete(e):b.set(e,n)}}const ue=self;ue.onconnect=r=>{const e=r.ports[0],t=ee++;x.set(t,e),e.onmessage=n=>{re(t,e,n.data)},e.addEventListener("close",()=>ie(e)),e.start()}})();
