(function(){"use strict";function E(n,e,t){return c.ensure_ingested(n,e,t)}function L(n,e){const t=c.get_available_time_controls(n,e);if(t[2])throw f(t[1]);return f(t[0])}function W(n,e,t,r,_,o){const a=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),i=d;var l=w(_)?0:y(_,c.__wbindgen_malloc,c.__wbindgen_realloc),R=d;const O=c.get_continuations(n,e,t,a,i,l,R,o);if(O[2])throw f(O[1]);return f(O[0])}function q(n){const e=c.get_games_metadata(n);if(e[2])throw f(e[1]);return f(e[0])}function C(n){const e=c.get_games_moves(n);if(e[2])throw f(e[1]);return f(e[0])}function F(){const n=c.get_player_info();if(n[2])throw f(n[1]);return f(n[0])}function B(n,e,t,r){const _=c.get_recent_games(n,e,t,r);if(_[2])throw f(_[1]);return f(_[0])}function P(){return c.get_schema_version()>>>0}function H(n,e){const t=y(n,c.__wbindgen_malloc,c.__wbindgen_realloc),r=d,_=y(e,c.__wbindgen_malloc,c.__wbindgen_realloc),o=d;return c.init_vfs(t,r,_,o)}function z(){return c.open_database()}function G(n,e,t,r,_){const o=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),a=d;var i=w(_)?0:y(_,c.__wbindgen_malloc,c.__wbindgen_realloc),l=d;const R=c.search_by_position(n,e,t,o,a,i,l);if(R[2])throw f(R[1]);return f(R[0])}function V(){return{__proto__:null,"./chess_db_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){return Error(b(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const r=String(t),_=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=d;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg___wbindgen_boolean_get_bbbb1c18aa2f5e25:function(e){const t=e,r=typeof t=="boolean"?t:void 0;return w(r)?16777215:r?1:0},__wbg___wbindgen_debug_string_0bc8482c6e3508ae:function(e,t){const r=M(t),_=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=d;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg___wbindgen_is_function_0095a73b8b156f76:function(e){return typeof e=="function"},__wbg___wbindgen_is_object_5ae8e5880f2c1fbd:function(e){const t=e;return typeof t=="object"&&t!==null},__wbg___wbindgen_is_undefined_9e4d92534c42d778:function(e){return e===void 0},__wbg___wbindgen_jsval_loose_eq_9dd77d8cd6671811:function(e,t){return e==t},__wbg___wbindgen_number_get_8ff4255516ccad3e:function(e,t){const r=t,_=typeof r=="number"?r:void 0;g().setFloat64(e+8,w(_)?0:_,!0),g().setInt32(e+0,!w(_),!0)},__wbg___wbindgen_string_get_72fb696202c56729:function(e,t){const r=t,_=typeof r=="string"?r:void 0;var o=w(_)?0:y(_,c.__wbindgen_malloc,c.__wbindgen_realloc),a=d;g().setInt32(e+4,a,!0),g().setInt32(e+0,o,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(b(e,t))},__wbg__wbg_cb_unref_d9b87ff7982e3b21:function(e){e._wbg_cb_unref()},__wbg_body_3a0b4437dadea6bf:function(e){const t=e.body;return w(t)?0:h(t)},__wbg_buffer_26d0910f3a5bc899:function(e){return e.buffer},__wbg_byteLength_3417f266f4bf562a:function(e){return e.byteLength},__wbg_byteOffset_f88547ca47c86358:function(e){return e.byteOffset},__wbg_call_389efe28435a9388:function(){return s(function(e,t){return e.call(t)},arguments)},__wbg_call_4708e0c13bdc8e95:function(){return s(function(e,t,r){return e.call(t,r)},arguments)},__wbg_createSyncAccessHandle_6457c2b3542fa571:function(e){return e.createSyncAccessHandle()},__wbg_done_57b39ecd9addfe81:function(e){return e.done},__wbg_entries_04a4b982351a717f:function(e){return e.entries()},__wbg_entries_58c7934c745daac7:function(e){return Object.entries(e)},__wbg_fetch_a9bc66c159c18e19:function(e){return fetch(e)},__wbg_fill_5a59b1df3387126e:function(e,t,r,_){return e.fill(t,r>>>0,_>>>0)},__wbg_flush_22b785060592ca5f:function(){return s(function(e){e.flush()},arguments)},__wbg_getDate_db46eca87d2b4907:function(e){return e.getDate()},__wbg_getDay_ac81e9e1156dfde2:function(e){return e.getDay()},__wbg_getDirectoryHandle_87ce8ca53cf4d8dc:function(e,t,r,_){return e.getDirectoryHandle(b(t,r),_)},__wbg_getDirectory_b66ae3e79f902982:function(e){return e.getDirectory()},__wbg_getFileHandle_ff4ab917b45affb3:function(e,t,r,_){return e.getFileHandle(b(t,r),_)},__wbg_getFullYear_30ddf266b7612036:function(e){return e.getFullYear()},__wbg_getHours_e02e88722301c418:function(e){return e.getHours()},__wbg_getMinutes_eb73ceeb8231f6f4:function(e){return e.getMinutes()},__wbg_getMonth_4af888e76b42bb51:function(e){return e.getMonth()},__wbg_getRandomValues_933a06e2370405af:function(){return s(function(e,t){globalThis.crypto.getRandomValues(m(e,t))},arguments)},__wbg_getReader_804829cfb24eb4dd:function(e){return e.getReader()},__wbg_getSeconds_d5269a98a03bab5e:function(e){return e.getSeconds()},__wbg_getSize_0a848f6914efc400:function(){return s(function(e){return e.getSize()},arguments)},__wbg_getTime_1e3cd1391c5c3995:function(e){return e.getTime()},__wbg_getTimezoneOffset_81776d10a4ec18a8:function(e){return e.getTimezoneOffset()},__wbg_getUint32_cb62f3b295fd220d:function(e,t){return e.getUint32(t>>>0)},__wbg_get_9b94d73e6221f75c:function(e,t){return e[t>>>0]},__wbg_get_b3ed3ad4be2bc8ac:function(){return s(function(e,t){return Reflect.get(e,t)},arguments)},__wbg_get_index_9a5bfdd2ca49c65f:function(e,t){return e[t>>>0]},__wbg_headers_5a897f7fee9a0571:function(e){return e.headers},__wbg_instanceof_ArrayBuffer_c367199e2fa2aa04:function(e){let t;try{t=e instanceof ArrayBuffer}catch{t=!1}return t},__wbg_instanceof_Error_8573fe0b0b480f46:function(e){let t;try{t=e instanceof Error}catch{t=!1}return t},__wbg_instanceof_Promise_0094681e3519d6ec:function(e){let t;try{t=e instanceof Promise}catch{t=!1}return t},__wbg_instanceof_ReadableStreamDefaultReader_8c3866331ce32722:function(e){let t;try{t=e instanceof ReadableStreamDefaultReader}catch{t=!1}return t},__wbg_instanceof_Response_ee1d54d79ae41977:function(e){let t;try{t=e instanceof Response}catch{t=!1}return t},__wbg_instanceof_Uint8Array_9b9075935c74707c:function(e){let t;try{t=e instanceof Uint8Array}catch{t=!1}return t},__wbg_instanceof_WorkerGlobalScope_07b9d5514ff0156e:function(e){let t;try{t=e instanceof WorkerGlobalScope}catch{t=!1}return t},__wbg_isArray_d314bb98fcf08331:function(e){return Array.isArray(e)},__wbg_iterator_6ff6560ca1568e55:function(){return Symbol.iterator},__wbg_length_32ed9a279acd054c:function(e){return e.length},__wbg_length_35a7bace40f36eac:function(e){return e.length},__wbg_message_9ddc4b9a62a7c379:function(e){return e.message},__wbg_name_446e25ef2cfdab5a:function(e){return e.name},__wbg_navigator_4478931f32ebca57:function(e){return e.navigator},__wbg_new_074b505417ada2d9:function(){return s(function(){return new URLSearchParams},arguments)},__wbg_new_0_73afc35eb544e539:function(){return new Date},__wbg_new_245cd5c49157e602:function(e){return new Date(e)},__wbg_new_2ac7fa8be584d280:function(e,t,r){return new DataView(e,t>>>0,r>>>0)},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_new_64284bd487f9d239:function(){return s(function(){return new Headers},arguments)},__wbg_new_b5d9e2fb389fef91:function(e,t){try{var r={a:e,b:t},_=(a,i)=>{const l=r.a;r.a=0;try{return Y(l,r.b,a,i)}finally{r.a=l}};return new Promise(_)}finally{r.a=r.b=0}},__wbg_new_c2f21774701ddac7:function(){return s(function(e,t){return new URL(b(e,t))},arguments)},__wbg_new_dd2b680c8bf6ae29:function(e){return new Uint8Array(e)},__wbg_new_no_args_1c7c842f08d00ebb:function(e,t){return new Function(b(e,t))},__wbg_new_with_length_a2c39cbe88fd8ff1:function(e){return new Uint8Array(e>>>0)},__wbg_new_with_str_a7c7f835549b152a:function(){return s(function(e,t){return new Request(b(e,t))},arguments)},__wbg_new_with_str_and_init_a61cbc6bdef21614:function(){return s(function(e,t,r){return new Request(b(e,t),r)},arguments)},__wbg_new_with_year_month_day_bae39ca1cb72136b:function(e,t,r){return new Date(e>>>0,t,r)},__wbg_next_0a5e0f8af98146aa:function(){return s(function(e){return e.next()},arguments)},__wbg_next_3482f54c49e8af19:function(){return s(function(e){return e.next()},arguments)},__wbg_next_418f80d8f5303233:function(e){return e.next},__wbg_now_a3af9a2f4bbaa4d1:function(){return Date.now()},__wbg_ok_87f537440a0acf85:function(e){return e.ok},__wbg_prototypesetcall_bdcdcc5842e4d77d:function(e,t,r){Uint8Array.prototype.set.call(m(e,t),r)},__wbg_queueMicrotask_0aa0a927f78f5d98:function(e){return e.queueMicrotask},__wbg_queueMicrotask_5bb536982f78a56f:function(e){queueMicrotask(e)},__wbg_random_912284dbf636f269:function(){return Math.random()},__wbg_read_2bd3e0082033991e:function(){return s(function(e,t,r){return e.read(t,r)},arguments)},__wbg_read_68fd377df67e19b0:function(e){return e.read()},__wbg_read_f161889777645afd:function(){return s(function(e,t,r,_){return e.read(m(t,r),_)},arguments)},__wbg_resolve_002c4b7d9d8f6b64:function(e){return Promise.resolve(e)},__wbg_search_143f09a35047e800:function(e,t){const r=t.search,_=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=d;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg_setUint32_a531b0e13441116c:function(e,t,r){e.setUint32(t>>>0,r>>>0)},__wbg_set_3f1d0b984ed272ed:function(e,t,r){e[t]=r},__wbg_set_at_e453cf3f4be9e2d9:function(e,t){e.at=t},__wbg_set_cc56eefd2dd91957:function(e,t,r){e.set(m(t,r))},__wbg_set_create_1f902c5936adde7d:function(e,t){e.create=t!==0},__wbg_set_create_c95ddca018fac9ce:function(e,t){e.create=t!==0},__wbg_set_db769d02949a271d:function(){return s(function(e,t,r,_,o){e.set(b(t,r),b(_,o))},arguments)},__wbg_set_f43e577aea94465b:function(e,t,r){e[t>>>0]=r},__wbg_set_headers_cfc5f4b2c1f20549:function(e,t){e.headers=t},__wbg_set_method_c3e20375f5ae7fac:function(e,t,r){e.method=b(t,r)},__wbg_set_search_1d369b0f3868e132:function(e,t,r){e.search=b(t,r)},__wbg_static_accessor_GLOBAL_12837167ad935116:function(){const e=typeof global>"u"?null:global;return w(e)?0:h(e)},__wbg_static_accessor_GLOBAL_THIS_e628e89ab3b1c95f:function(){const e=typeof globalThis>"u"?null:globalThis;return w(e)?0:h(e)},__wbg_static_accessor_SELF_a621d3dfbb60d0ce:function(){const e=typeof self>"u"?null:self;return w(e)?0:h(e)},__wbg_static_accessor_WINDOW_f8727f0cf888e0bd:function(){const e=typeof window>"u"?null:window;return w(e)?0:h(e)},__wbg_status_89d7e803db911ee7:function(e){return e.status},__wbg_storage_c002b53bc4883299:function(e){return e.storage},__wbg_subarray_a96e1fef17ed23cb:function(e,t,r){return e.subarray(t>>>0,r>>>0)},__wbg_text_083b8727c990c8c0:function(){return s(function(e){return e.text()},arguments)},__wbg_then_0d9fe2c7b1857d32:function(e,t,r){return e.then(t,r)},__wbg_then_b9e7b3b5f1a9e1b5:function(e,t){return e.then(t)},__wbg_toString_029ac24421fd7a24:function(e){return e.toString()},__wbg_toString_964ff7fe6eca8362:function(e){return e.toString()},__wbg_truncate_ce7c4fbc0eec97a1:function(){return s(function(e,t){e.truncate(t)},arguments)},__wbg_truncate_dc661fdcb0062fa7:function(){return s(function(e,t){e.truncate(t>>>0)},arguments)},__wbg_url_36c39f6580d05409:function(e,t){const r=t.url,_=y(r,c.__wbindgen_malloc,c.__wbindgen_realloc),o=d;g().setInt32(e+4,o,!0),g().setInt32(e+0,_,!0)},__wbg_value_0546255b415e96c1:function(e){return e.value},__wbg_write_2d59337cc496919d:function(){return s(function(e,t,r,_){return e.write(m(t,r),_)},arguments)},__wbg_write_2f06684823b49afb:function(){return s(function(e,t,r){return e.write(t,r)},arguments)},__wbindgen_cast_0000000000000001:function(e,t){return J(e,t,c.wasm_bindgen__closure__destroy__hcdd03d0ab3a5230c,N)},__wbindgen_cast_0000000000000002:function(e){return e},__wbindgen_cast_0000000000000003:function(e){return e},__wbindgen_cast_0000000000000004:function(e,t){return b(e,t)},__wbindgen_init_externref_table:function(){const e=c.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)}}}}function N(n,e,t){c.wasm_bindgen__convert__closures_____invoke__h5d5c897e17218bb0(n,e,t)}function Y(n,e,t,r){c.wasm_bindgen__convert__closures_____invoke__h48e0ae2f1b2979a4(n,e,t,r)}function h(n){const e=c.__externref_table_alloc();return c.__wbindgen_externrefs.set(e,n),e}const U=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(n=>n.dtor(n.a,n.b));function M(n){const e=typeof n;if(e=="number"||e=="boolean"||n==null)return`${n}`;if(e=="string")return`"${n}"`;if(e=="symbol"){const _=n.description;return _==null?"Symbol":`Symbol(${_})`}if(e=="function"){const _=n.name;return typeof _=="string"&&_.length>0?`Function(${_})`:"Function"}if(Array.isArray(n)){const _=n.length;let o="[";_>0&&(o+=M(n[0]));for(let a=1;a<_;a++)o+=", "+M(n[a]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(n));let r;if(t&&t.length>1)r=t[1];else return toString.call(n);if(r=="Object")try{return"Object("+JSON.stringify(n)+")"}catch{return"Object"}return n instanceof Error?`${n.name}: ${n.message}
${n.stack}`:r}function m(n,e){return n=n>>>0,A().subarray(n/1,n/1+e)}let p=null;function g(){return(p===null||p.buffer.detached===!0||p.buffer.detached===void 0&&p.buffer!==c.memory.buffer)&&(p=new DataView(c.memory.buffer)),p}function b(n,e){return n=n>>>0,X(n,e)}let S=null;function A(){return(S===null||S.byteLength===0)&&(S=new Uint8Array(c.memory.buffer)),S}function s(n,e){try{return n.apply(this,e)}catch(t){const r=h(t);c.__wbindgen_exn_store(r)}}function w(n){return n==null}function J(n,e,t,r){const _={a:n,b:e,cnt:1,dtor:t},o=(...a)=>{_.cnt++;const i=_.a;_.a=0;try{return r(i,_.b,...a)}finally{_.a=i,o._wbg_cb_unref()}};return o._wbg_cb_unref=()=>{--_.cnt===0&&(_.dtor(_.a,_.b),_.a=0,U.unregister(_))},U.register(o,_,_),o}function y(n,e,t){if(t===void 0){const i=k.encode(n),l=e(i.length,1)>>>0;return A().subarray(l,l+i.length).set(i),d=i.length,l}let r=n.length,_=e(r,1)>>>0;const o=A();let a=0;for(;a<r;a++){const i=n.charCodeAt(a);if(i>127)break;o[_+a]=i}if(a!==r){a!==0&&(n=n.slice(a)),_=t(_,r,r=a+n.length*3,1)>>>0;const i=A().subarray(_+a,_+r),l=k.encodeInto(n,i);a+=l.written,_=t(_,r,a,1)>>>0}return d=a,_}function f(n){const e=c.__wbindgen_externrefs.get(n);return c.__externref_table_dealloc(n),e}let $=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});$.decode();const K=2146435072;let x=0;function X(n,e){return x+=e,x>=K&&($=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),$.decode(),x=e),$.decode(A().subarray(n,n+e))}const k=new TextEncoder;"encodeInto"in k||(k.encodeInto=function(n,e){const t=k.encode(n);return e.set(t),{read:n.length,written:t.length}});let d=0,c;function Q(n,e){return c=n.exports,p=null,S=null,c.__wbindgen_start(),c}async function Z(n,e){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,e)}catch(_){if(n.ok&&t(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",_);else throw _}const r=await n.arrayBuffer();return await WebAssembly.instantiate(r,e)}else{const r=await WebAssembly.instantiate(n,e);return r instanceof WebAssembly.Instance?{instance:r,module:n}:r}function t(r){switch(r){case"basic":case"cors":case"default":return!0}return!1}}async function ee(n){if(c!==void 0)return c;n!==void 0&&(Object.getPrototypeOf(n)===Object.prototype?{module_or_path:n}=n:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),n===void 0&&(n=new URL(""+new URL("chess_db_bg-Dq1KGBLq.wasm",self.location.href).href,self.location.href));const e=V();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:t,module:r}=await Z(await n,e);return Q(t)}let D=null,I="[db-worker]";const v=new Set,T=new Map;function j(n){const e=[];for(const[t,r]of Object.entries(n))if(!(t==="type"||t==="port")){if(Array.isArray(r)){e.push(`${t}:[${r.length} items]`);continue}if(t==="data"&&typeof r=="object"&&r!==null){const _=Object.entries(r).map(([o,a])=>Array.isArray(a)?`${o}:${a.length}`:`${o}:${a}`).join(", ");e.push(`data:{${_}}`);continue}if(t==="pattern"&&typeof r=="object"&&r!==null){e.push(`pattern:{${r.pieces?.length??0} pieces}`);continue}e.push(`${t}:${r}`)}return e.length>0?` {${e.join(", ")}}`:""}async function te(n,e){navigator.locks.request(`chess-worker-${e}-${n}`,()=>new Promise(()=>{})),console.log("[db-worker] WASM init starting..."),await ee(),console.log("[db-worker] WASM init done. init_vfs starting..."),await H(n,e),console.log("[db-worker] init_vfs done. open_database starting..."),await z(),console.log(`[db-worker] Ready: ${e}/${n}, schema v${P()}`)}function u(n){console.log(`${I} → ${n.type}${j(n)}`),D.postMessage(n)}async function ne(n){if(console.log(`${I} ← ${n.type}${j(n)}`),n.type==="cancel"){v.add(n.cancelRequestId);return}const{requestId:e}=n;try{switch(n.type){case"ensureIngested":{const t=r=>(u({type:"progress",requestId:e,message:r}),!v.has(e));await E(n.since,n.until,t),v.delete(e),u({type:"result",requestId:e,data:null});try{const r=F();u({type:"playerInfoUpdated",data:r})}catch(r){console.error("[db-worker] Failed to get player info after ingestion:",r)}break}case"getContinuations":{const t=W(n.since,n.until,n.moveSequence,n.playerColor,n.timeControl??void 0,n.includeTranspositions);u({type:"result",requestId:e,data:t});break}case"searchByPosition":{const t=n.tabId,r=(T.get(t)??0)+1;if(T.set(t,r),await new Promise(o=>{const a=new MessageChannel;a.port1.onmessage=()=>o(),a.port2.postMessage(null)}),r!==T.get(t)){u({type:"conflated",requestId:e});break}const _=G(n.since,n.until,n.pattern.pieces,n.playerColor,n.timeControl??void 0);u({type:"result",requestId:e,data:_});break}case"getGamesMetadata":{const t=q(n.gameIds);u({type:"result",requestId:e,data:t});break}case"getGamesMoves":{const t=C(n.gameIds);u({type:"result",requestId:e,data:t});break}case"getRecentGames":{const t=B(n.since,n.until,n.timeControl??null,n.limit);u({type:"result",requestId:e,data:t});break}case"getAvailableTimeControls":{const t=L(n.since,n.until);u({type:"result",requestId:e,data:t});break}case"getPlayerInfo":{const t=F();u({type:"result",requestId:e,data:t});break}default:u({type:"error",requestId:e,error:`Unknown message type: ${n.type}`})}}catch(t){v.delete(e);const r=String(t);r.includes("Cancelled")?u({type:"error",requestId:e,error:"AbortError"}):u({type:"error",requestId:e,error:r})}}self.onmessage=async n=>{const e=n.data;if(e.type!=="init")return;const{username:t,platform:r}=e;D=e.port,I=`[db-worker:${r}/${t}]`,console.log(`${I} ← init`),self.onmessage=null,await te(t,r),D.onmessage=_=>ne(_.data),u({type:"ready"})}})();
